<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<script type="module" src="js-lite/watcher.js"></script>
<script type="module">
    import Watcher from './js-lite/watcher.js';
    import {observe} from './js-lite/observer.js';

    class DataStore {
        constructor(value) {
            const data = {};
            if (value) {
                Object.assign(data, value);
            }
            // 为了满足 watcher 的需求
            Object.defineProperty(data, '_watchers', {
                configurable: false,    // 不可重定义
                enumerable: false,      // 不可被遍历
                writable: true,         // 可修改?
                value: [],
            });

            observe(data, true);

            Object.defineProperty(this, '_data', {
                configurable: false,    // 不可重定义
                enumerable: false,      // 不可被遍历
                writable: true,         // 可修改?
                value: data,
            });

            // 数据代理
            // 实现 vm.xxx -> vm._data.xxx
            Object.keys(data).forEach(key => this._proxyData(key));
        }

        _proxyData (key, setter, getter) {
            setter = setter ||
                Object.defineProperty(this, key, {
                    configurable: false,
                    enumerable: true,
                    get() {
                        return this._data[key];
                    },
                    set(newVal) {
                        this._data[key] = newVal;
                        // // 如果以前存在 key 值的话, 在初始化的 observe 里应该就已经监听过了
                        // let hasBefore = !!this._data[key];
                        // if (!hasBefore) {
                        //     //TODO 是不是应该还要再往根树的监听依赖上加一下
                        //     observe(newVal);
                        // }
                    },
                });
        }

        watch(key, cb) {
            new Watcher(this._data, key, cb, {
                user: true,
                deep: true,
            });
        }

        setIn(path, value) {

        }
    }

    var ds = new DataStore({
        obj: {
            a: 3
        },
        a: 1,
        b: 2,
    });

    console.log(ds);

    window.ds = ds;

    ds.watch('obj.a', (...args) => console.log(...args));

    ds.obj.a = 1;
</script>
</body>
</html>